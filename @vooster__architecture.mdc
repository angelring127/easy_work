# Workeasy – Architecture Document

## 최근 업데이트 (2024-12-03)

### 매장 사용자 관리 기능 개선

#### 1. 서브 매니저 회수 기능 개선

- **기존**: 서브 매니저 → 비활성화
- **개선**: 서브 매니저 → 파트타이머로 전환
- **API**: `POST /api/stores/[id]/users/demote`
- **함수**: `demote_sub_manager_to_part_timer()`

#### 2. 사용자 비활성화 기능 추가

- **기능**: 사용자를 비활성화하여 매장에서 일시적으로 제외
- **API**: `POST /api/stores/[id]/users/deactivate`
- **함수**: `deactivate_user()`
- **재활성화**: `POST /api/stores/[id]/users/reactivate`
- **함수**: `reactivate_user()`

#### 3. 사용자 삭제 기능 추가

- **기능**: 사용자를 소프트 삭제 (스케줄 이력 보존)
- **API**: `POST /api/stores/[id]/users/delete`
- **함수**: `soft_delete_user()`
- **특징**: `deleted_at` 컬럼으로 소프트 삭제 구현

#### 4. 데이터베이스 스키마 변경

- `user_store_roles` 테이블에 `deleted_at` 컬럼 추가
- 소프트 삭제를 위한 인덱스 생성
- RLS 정책 업데이트 (삭제된 사용자 제외)

#### 5. UI 개선

- 서브 매니저 전환 버튼
- 사용자 비활성화/재활성화 버튼
- 사용자 삭제 버튼
- 확인 다이얼로그 추가

#### 6. 다국어 지원

- 새로운 기능에 대한 한국어/영어/일본어 번역 추가
- 확인 메시지 및 오류 메시지 다국어화

#### 7. 문제 해결 (2024-12-03)

- **상단 네비게이션 바 누락**: 사용자 관리 페이지에 대시보드와 동일한 헤더 추가
- **초대 탭 번역 키 표시**: 초대 관련 번역 키 추가 (한국어/영어/일본어)
- **권한 문제**: SUB_MANAGER에 MANAGE_USER_ROLES 권한 추가하여 사용자 관리 접근 가능하도록 수정

#### 8. 추가 문제 해결 (2024-12-03)

- **매장 관리 페이지 상단 네비게이션 바**: 대시보드와 동일한 헤더 구조로 통일
- **사용자 관리 페이지 뒤로가기 버튼**: 매장 관리 페이지로 돌아가는 뒤로가기 버튼 추가
- **일관된 UI/UX**: 모든 페이지에서 동일한 네비게이션 경험 제공

#### 9. 추가 문제 해결 (2024-12-03)

- **사용자 관리 뒤로가기 버튼 수정**: 매장 상세 정보 대신 대시보드로 이동하도록 수정
- **매장 관리 리스트 페이지 상단 네비게이션 바**: 대시보드와 동일한 헤더 구조로 통일
- **네비게이션 일관성**: 모든 페이지에서 일관된 사용자 경험 제공

#### 10. 사용자 관리 UI 개선 (2024-12-03)

- **삭제된 사용자 시각적 구분**: 삭제된 사용자의 배경을 회색으로 표시하고 투명도 적용
- **삭제된 사용자 버튼 비활성화**: 모든 액션 버튼을 disabled로 설정하여 조작 방지
- **삭제 상태 표시**: 삭제된 사용자의 상태를 "삭제됨"으로 표시
- **사용자 경험 개선**: 삭제된 사용자를 명확하게 구분하여 혼란 방지

#### 11. 사용자 관리 추가 개선 (2024-12-03)

- **삭제된 사용자 상태 배지 수정**: 삭제된 사용자의 상태 배지를 회색으로 표시
- **중복 삭제 방지**: 이미 삭제된 사용자에 대한 삭제 버튼 클릭 시 경고 메시지 표시
- **다국어 지원**: 삭제 관련 메시지에 한국어/영어/일본어 번역 추가
- **데이터 무결성**: 삭제된 사용자에 대한 실수 방지 및 명확한 피드백 제공

#### 12. 런타임 오류 수정 (2024-12-03)

- **null 참조 오류 수정**: user 객체가 null일 때 email 속성 접근 오류 해결
- **조건부 렌더링 개선**: user 객체 존재 여부를 확인하는 안전한 접근 방식 적용
- **로딩 상태 관리**: isLoading 변수명 충돌 해결 및 일관된 로딩 상태 관리
- **안정성 향상**: 런타임 오류 방지를 통한 사용자 경험 개선

#### 13. 초대 시스템 개선 (2024-12-03)

- **중복 사용자 생성 문제 해결**: createUser() 제거하고 inviteUserByEmail()만 사용
- **이메일 발송 로직 단순화**: 기존/신규 사용자 구분 없이 통합된 이메일 발송
- **오류 처리 개선**: 중복 생성으로 인한 "이미 등록된 이메일" 오류 방지
- **코드 구조 개선**: 불필요한 복잡성 제거 및 단순한 초대 플로우 구현

#### 14. 초대 토큰 처리 개선 (2024-12-03)

- **토큰 추출 로직 개선**: URL 파라미터와 사용자 메타데이터에서 토큰을 모두 확인
- **초대 정보 조회 수정**: undefined 토큰으로 인한 404 오류 해결
- **사용자 메타데이터 활용**: Supabase Auth에서 전달된 token_hash를 우선적으로 사용
- **디버깅 로그 추가**: 토큰 추출 과정을 추적할 수 있는 상세한 로그 구현

#### 15. 초대 페이지 접근 문제 해결 (2024-12-03)

- **미들웨어 수정**: /invites/verify-email을 공개 경로로 추가하여 인증 없이 접근 가능
- **디버깅 로그 강화**: verify-email 페이지 로드 과정을 상세히 추적할 수 있는 로그 추가
- **페이지 접근성 개선**: 초대 링크로 접속 시 verify-email 페이지가 정상적으로 로드되도록 수정
- **문제 진단 강화**: URL, 해시, 파라미터 등 모든 관련 정보를 로깅하여 문제 원인 파악

#### 16. 초대 수락 후 매장 목록 동기화 개선 (2024-12-03)

- **매장 목록 새로고침 강화**: 초대 수락 후 즉시 매장 목록을 새로고침하여 대시보드에 반영
- **대시보드 자동 새로고침**: 사용자 변경 시 자동으로 매장 목록을 새로고침하는 로직 추가
- **StoreContext 로깅 강화**: 매장 목록 로드 과정을 상세히 추적할 수 있는 로그 추가
- **사용자 경험 개선**: 새로고침 없이도 초대된 매장이 즉시 대시보드에 표시되도록 수정

---

## 기존 아키텍처 내용

### 1. 시스템 개요

Workeasy는 Next.js 기반의 PWA를 사용하여 소규모 카페 및 음식점의 교대 근무표 자동 생성 및 관리, 실시간 팀 커뮤니케이션을 지원하는 SaaS 솔루션입니다.

### 2. 기술 스택

- **Frontend**: Next.js 15, TypeScript, TailwindCSS, shadcn/ui
- **Backend**: Supabase (PostgreSQL, Auth, Realtime)
- **State Management**: @tanstack/react-query, zustand
- **Internationalization**: 커스텀 i18n 시스템

### 3. 핵심 기능

- 사용자 인증 및 권한 관리 (RBAC)
- 매장 관리 및 사용자 초대
- 스케줄 자동 생성 및 관리
- 실시간 채팅 및 알림
- 다국어 지원 (한국어/영어/일본어)

### 4. 데이터베이스 설계

- **stores**: 매장 정보
- **user_store_roles**: 사용자-매장-역할 관계
- **invitations**: 초대 시스템
- **temporary_assignments**: 임시 근무 배치
- **audit_logs**: 감사 로그

### 5. 보안

- Row Level Security (RLS) 정책
- JWT 기반 인증
- 권한 기반 접근 제어
- 감사 로그 시스템

### 6. 성능 최적화

- 서버 사이드 렌더링 (SSR)
- 데이터 캐싱 (@tanstack/react-query)
- 이미지 최적화
- 코드 분할

### 7. 배포 및 운영

- Vercel 배포
- Supabase 호스팅
- 환경별 설정 관리
- 모니터링 및 로깅
